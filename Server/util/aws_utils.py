import boto3


def delete_mirror_session_by_id(ec2_ressource, mirror_session_id: str) -> None:
    ec2_ressource.meta.client.delete_traffic_mirror_session(
        TrafficMirrorSessionId=mirror_session_id,
    )


def delete_mirror_filter_id_by_id(ec2_ressource, mirror_filter_id: str, mirror_filter_rules: list[str]) -> None:
    for mirror_filter_rule_id in mirror_filter_rules:
        ec2_ressource.meta.client.delete_traffic_mirror_filter_rule(
            TrafficMirrorFilterRuleId=mirror_filter_rule_id
        )

    ec2_ressource.meta.client.delete_traffic_mirror_filter(
        TrafficMirrorFilterId=mirror_filter_id
    )


def delete_mirror_target_by_id(ec2_ressource, mirror_target_id: str) -> None:

    ec2_ressource.meta.client.delete_traffic_mirror_target(
        TrafficMirrorTargetId=mirror_target_id
    )


def terminate_ec2_by_id(ec2_ressource, instance_id: str) -> None:

    instance = ec2_ressource.Instance(instance_id)
    instance.terminate()
    print(f'Terminating EC2 instance: {instance.id}')
    instance.wait_until_terminated()


def create_mirror_target(ec2_ressource, target_eni_id):

    return ec2_ressource.meta.client.create_traffic_mirror_target(
        NetworkInterfaceId=target_eni_id
    )['TrafficMirrorTarget']['TrafficMirrorTargetId']


def create_mirror_filter(ec2_ressource):

    filter_id = ec2_ressource.meta.client.create_traffic_mirror_filter(
    )['TrafficMirrorFilter']['TrafficMirrorFilterId']

    rules_id = []

    resp = ec2_ressource.meta.client.create_traffic_mirror_filter_rule(
        TrafficMirrorFilterId=filter_id,
        TrafficDirection='ingress',
        RuleNumber=1,
        RuleAction='accept',
        DestinationCidrBlock='0.0.0.0/0',
        SourceCidrBlock='0.0.0.0/0'
    )

    # print(resp)
    rules_id.append(resp['TrafficMirrorFilterRule']
                    ['TrafficMirrorFilterRuleId'])

    resp = ec2_ressource.meta.client.create_traffic_mirror_filter_rule(
        TrafficMirrorFilterId=filter_id,
        TrafficDirection='egress',
        RuleNumber=1,
        RuleAction='accept',
        DestinationCidrBlock='0.0.0.0/0',
        SourceCidrBlock='0.0.0.0/0'
    )
    # rules_id.append(resp['TrafficMirrorFilterRule']
    #                 ['TrafficMirrorFilterRuleId'])

    return filter_id, rules_id


def create_mirror_session(ec2_ressource, mirror_target_id, mirror_filter_id, network_interface_id):

    return ec2_ressource.meta.client.create_traffic_mirror_session(
        NetworkInterfaceId=network_interface_id,
        # NetworkInterfaceId=instance['NetworkInterfaces'][0]['NetworkInterfaceId'],
        TrafficMirrorTargetId=mirror_target_id,
        TrafficMirrorFilterId=mirror_filter_id,
        SessionNumber=1
    )['TrafficMirrorSession']['TrafficMirrorSessionId']


def getSecurityGroupID(ec2_ressource, malware_sandboxed_VPC_id: str) -> str:
    SecurityGroup = ec2_ressource.meta.client.describe_security_groups(

        Filters=[{"Name": "tag:Name", "Values": ["Malware_Env_Security_Group"]}]
    )
    return SecurityGroup['SecurityGroups'][0]["GroupId"]


def getSubnetID(ec2_ressource, malware_sandboxed_VPC_id: str) -> str:
    subnets = ec2_ressource.subnets.filter(
        Filters=[{"Name": "vpc-id", "Values": [malware_sandboxed_VPC_id]}]
    )
    subnet_ids = [sn.id for sn in subnets]
    return subnet_ids[0]


def getVpcID(ec2_ressource, vpc_name: str, cidr_block: str) -> str:

    malware_sandboxed_VPC = ec2_ressource.meta.client.describe_vpcs(
        Filters=[
            {
                'Name': 'tag:Name',
                'Values': [
                    vpc_name,
                ]
            },
            {
                'Name': 'cidr-block-association.cidr-block',
                'Values': [
                    cidr_block,
                ]
            },
        ]
    )

    malware_sandboxed_VPC = malware_sandboxed_VPC['Vpcs']

    malware_sandboxed_VPC_id = malware_sandboxed_VPC[0]["VpcId"]

    return malware_sandboxed_VPC_id


def getInstanceIdAndNetworkInterfaceID(ec2_ressource, instance_name: str) -> str:
    instances = ec2_ressource.meta.client.describe_instances(
        Filters=[
            {
                'Name': 'tag:Name',
                'Values': [
                    instance_name
                ]
            }
        ]
    )
    return instances["Reservations"][0]['Instances'][0]['InstanceId'], instances["Reservations"][0]['Instances'][0]['NetworkInterfaces'][0]['NetworkInterfaceId']


def getInitialData():

    region_name = 'us-west-2'
    ec2_ressource = boto3.resource('ec2', region_name=region_name)
    initial_data = {}

    initial_data['AMI'] = "ami-0e6dff8bde9a09539"
    initial_data['MAIN_SERVER_INSTANCE_ID'], initial_data['MAIN_SERVER_NETWORK_INTERFACE_ID'] = getInstanceIdAndNetworkInterfaceID(
        ec2_ressource, "mainbSanbServer")
    initial_data['VPC_ID'] = getVpcID(
        ec2_ressource, 'Malware_Env_VPC', '10.1.0.0/18')
    initial_data['SUBNET_ID'] = getSubnetID(
        ec2_ressource, initial_data['VPC_ID'])
    initial_data['SECURITY_GROUP_ID'] = getSecurityGroupID(
        ec2_ressource, "Malware_Env_Security_Group")
<<<<<<< Updated upstream
    # initial_data['INSTANCE_TYPE'] = 't2.micro'
    # initial_data['ISNITRO'] = False
    initial_data['INSTANCE_TYPE'] = 't3.micro'
    initial_data['ISNITRO'] = True

=======

    initial_data["mirror_target_id"] = getMirrorTargetIdByName(
        ec2_ressource, "mainbSanbServer_mirrorTarget")

    initial_data['INSTANCE_TYPE'] = 't3.medium'  # t2.micro
    initial_data['ISNITRO'] = True

    initial_data['IS_LINUX_INSTANCE'] = False
    initial_data['AMI'] = "ami-043e4accabc6fc556"  # windows server
    # initial_data['AMI'] = "ami-0e6dff8bde9a09539"#UBUNTU

    initial_data['MALWARE_SANDBOXED_KEYNAME'] = "MalwareSanbServer_private_key"
    initial_data['MALWARE_SANDBOXED_KEYNAME_PATH'] = "../.ssh/MalwareSanbServer_private_key.pem"

    initial_data['MALWARE_SERVER_ONLAUNCH_COMMAND'] = ['ping 8.8.8.8']

    initial_data['MALWARE_SERVER_ONLAUNCH_USERDATA'] = """#cloud-config
    runcmd:
     - /home/ec2-user/sudo npm run prod
     - cd /tmp
     - curl https://amazon-ssm-%s.s3.amazonaws.com/latest/linux_amd64/amazon-ssm-agent.rpm -o amazon-ssm-agent.rpm
     - yum install -y amazon-ssm-agent.rpm
""" % region_name

    if initial_data['IS_LINUX_INSTANCE']:
        initial_data['MALWARE_SERVER_ONLAUNCH_USERDATA'] = "<script>" + \
            "ping 8.8.8.8" + "</script>"

>>>>>>> Stashed changes
    print("****************************************************")
    print("initial_data: {}".format(initial_data))
    print("****************************************************")

    return initial_data
