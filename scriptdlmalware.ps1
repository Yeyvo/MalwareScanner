
Write-Debug "Got this function from https://stackoverflow.com/questions/64682048/unzip-a-password-protected-file-with-powershell, Requires 7-zip"
Write-Debug "https://www.7-zip.org/download.html + and save it C:\Program Files\7-Zip\7z.exe "
Write-Debug "As cmd Expand-Archive doesn't do the job"

Function Open-7ZipFile{
    Param(
        [Parameter(Mandatory=$true)]
        [string]$Source,
        [Parameter(Mandatory=$true)]
        [string]$Destination,
        [string]$Password,
        [Parameter(Mandatory=$true)]
        [string]$ExePath7Zip,
        [switch]$Silent
    )
    $Command = "& `"$ExePath7Zip`" e -o`"$Destination`" -y" + $(if($Password.Length -gt 0){" -p`"$Password`""}) + " `"$Source`""
    If($Silent){
        Invoke-Expression $Command | out-null
    }else{
        "$Command"
        Invoke-Expression $Command
    }
}

Write-Debug "Example of a SHA256_Hash here >>>> The Parameter to use to DL a Malware <<<<<<<<"
$hash_of_file = '9569ac51e61f8ea7ce2b11790f255b66477370848d213950152f42dae512e220'

Write-Debug "Body of the request"
$params = @{'query'='get_file'; 'sha256_hash'= $hash_of_file}

Write-Debug "Check >>> https://bazaar.abuse.ch/api/#download <<< to get these infos"
$filename = "./sample"
Invoke-WebRequest -Method POST -Body $params -Uri https://mb-api.abuse.ch/api/v1/ -OutFile $filename".zip"

Open-7ZipFile -ExePath7Zip "C:\Program Files\7-Zip\7z.exe" -Source $filename".zip" -Destination $filename -Password "infected"

Set-Location $filename
$folders = Get-ChildItem .

Write-Output $folders.Name
Expand-Archive $folders.Name

$compromisedFile = Get-ChildItem $folders.Name.Split(".")[0]

Write-Output "Name of Compromised file "$compromisedFile.Name